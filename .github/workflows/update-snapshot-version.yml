name: Update Snapshot Version After Release

on:
  release:
    types: [published]

jobs:
  update-snapshot:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
      
      - name: Calculate next snapshot version
        id: next-version
        run: |
          RELEASE_TAG="${{ github.event.release.tag_name }}"
          echo "Release tag: $RELEASE_TAG"
          
          # Remove 'v' prefix if present (e.g., v0.0.1 -> 0.0.1)
          VERSION=${RELEASE_TAG#v}
          
          # Split version into parts (e.g., 0.0.1 -> 0 0 1)
          IFS='.' read -ra PARTS <<< "$VERSION"
          MAJOR=${PARTS[0]}
          MINOR=${PARTS[1]}
          PATCH=${PARTS[2]}
          
          # Increment patch version for next snapshot
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VERSION="$MAJOR.$MINOR.$NEXT_PATCH-SNAPSHOT"
          
          echo "Next snapshot version: $NEXT_VERSION"
          echo "next_version=$NEXT_VERSION" >> $GITHUB_OUTPUT
      
      - name: Update pom.xml version
        run: |
          mvn versions:set -DnewVersion=${{ steps.next-version.outputs.next_version }}
          mvn versions:commit
      
      - name: Update README.md
        run: |
          NEXT_VERSION="${{ steps.next-version.outputs.next_version }}"
          sed -i "s/<version>.*-SNAPSHOT<\/version>/<version>$NEXT_VERSION<\/version>/g" README.md
          sed -i "s/igrf-model:.*-SNAPSHOT'/igrf-model:$NEXT_VERSION'/g" README.md
          sed -i "s/\*\*Version .*-SNAPSHOT\*\*/\*\*Version $NEXT_VERSION\*\*/g" README.md
      
      - name: Commit version update
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add pom.xml README.md
          git commit -m "Bump snapshot version to ${{ steps.next-version.outputs.next_version }}"
          git push
